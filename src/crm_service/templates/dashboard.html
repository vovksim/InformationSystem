<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CRM Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 80%;
      margin: 40px auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h2, h3 {
      color: #333;
    }

    /* Add Order Form */
    .add-form {
      margin: 20px 0;
      background: #eef5ff;
      padding: 15px;
      border-radius: 8px;
    }

    .add-form input {
      padding: 8px;
      margin-right: 10px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-primary {
      background: #007bff;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-warning {
      background: #ffc107;
      color: black;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    th {
      background: #007bff;
      color: white;
    }

    tr:hover {
      background: #f1f1f1;
    }

    /* Modal for editing */
    #editModal {
      display: none;
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }

    .modal-content {
      background: white;
      width: 30%;
      margin: 150px auto;
      padding: 20px;
      border-radius: 10px;
    }

  </style>
</head>
<body>

<div class="container">

  <h2>Welcome {{ user.name }} ({{ user.role }})</h2>
  <h3>Your Orders</h3>

  <!-- ADD ORDER FORM -->
  <div class="add-form">
    <input type="text" id="newItem" placeholder="Item Name">
    <input type="number" id="newPrice" placeholder="Price">
    <button class="btn btn-primary" onclick="addOrder()">Add Order</button>
  </div>

  <!-- ORDERS TABLE -->
  <table>
    <tr>
      <th>ID</th>
      <th>Item</th>
      <th>Price</th>
      <th>Actions</th>
    </tr>

    {% for o in orders %}
      <tr id="row-{{ o._id }}">
        <td>{{ o._id }}</td>
        <td id="item-{{ o._id }}">{{ o.item }}</td>
        <td id="price-{{ o._id }}">{{ o.price }}</td>
        <td>
          <button class="btn btn-warning" onclick="openEdit('{{ o._id }}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteOrder('{{ o._id }}')">Delete</button>
        </td>
      </tr>
    {% endfor %}
  </table>

</div>


<!-- EDIT MODAL -->
<div id="editModal">
  <div class="modal-content">
    <h3>Edit Order</h3>
    <input type="hidden" id="editId">
    <input type="text" id="editItem" placeholder="Item Name"><br><br>
    <input type="number" id="editPrice" placeholder="Price"><br><br>

    <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    <button class="btn btn-danger" onclick="closeEdit()">Cancel</button>
  </div>
</div>

<script>
  // -----------------------
  // CREATE ORDER
  // -----------------------
  function addOrder() {
    const item = document.getElementById("newItem").value;
    const price = document.getElementById("newPrice").value;

    fetch("/api/orders", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({item, price})
    }).then(r => r.json()).then(data => {
      location.reload();
    });
  }

  // -----------------------
  // DELETE ORDER
  // -----------------------
  function deleteOrder(id) {
    if (!confirm("Delete this order?")) return;

    fetch("/api/orders/" + id, {
      method: "DELETE"
    }).then(r => r.json()).then(data => {
      document.getElementById("row-" + id).remove();
    });
  }

  // -----------------------
  // EDIT ORDER (open modal)
  // -----------------------
  function openEdit(id) {
    document.getElementById("editId").value = id;
    document.getElementById("editItem").value = document.getElementById("item-" + id).innerText;
    document.getElementById("editPrice").value = document.getElementById("price-" + id).innerText;

    document.getElementById("editModal").style.display = "block";
  }

  function closeEdit() {
    document.getElementById("editModal").style.display = "none";
  }

  // -----------------------
  // SAVE EDIT
  // -----------------------
  function saveEdit() {
    const id = document.getElementById("editId").value;
    const item = document.getElementById("editItem").value;
    const price = document.getElementById("editPrice").value;

    fetch("/api/orders/" + id, {
      method: "PUT",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({item, price})
    }).then(r => r.json()).then(data => {
      location.reload();
    });
  }
</script>

</body>
</html>
